import{_ as a,c as i,o as l,ag as n}from"./chunks/framework.DPDPlp3K.js";const c=JSON.parse('{"title":"Cloudflare Tunnel 部署指南","description":"","frontmatter":{},"headers":[],"relativePath":"guides/cloudflare-tunnel.md","filePath":"guides/cloudflare-tunnel.md","lastUpdated":1742547745000}'),e={name:"guides/cloudflare-tunnel.md"};function t(h,s,p,k,d,r){return l(),i("div",null,s[0]||(s[0]=[n(`<h1 id="cloudflare-tunnel-部署指南" tabindex="-1">Cloudflare Tunnel 部署指南 <a class="header-anchor" href="#cloudflare-tunnel-部署指南" aria-label="Permalink to &quot;Cloudflare Tunnel 部署指南&quot;">​</a></h1><p>本指南将帮助您设置 Cloudflare Tunnel，使您的 Go Mail Server 可以从外部网络安全访问，无需公网 IP 或复杂的网络配置。</p><h2 id="什么是-cloudflare-tunnel" tabindex="-1">什么是 Cloudflare Tunnel? <a class="header-anchor" href="#什么是-cloudflare-tunnel" aria-label="Permalink to &quot;什么是 Cloudflare Tunnel?&quot;">​</a></h2><p>Cloudflare Tunnel 提供了一种安全的方式，将您的本地服务连接到 Cloudflare 网络，使其可以从互联网安全访问，而无需在防火墙上开放端口或配置静态 IP。</p><p>对于 Go Mail Server，这意味着您可以：</p><ul><li>从任何地方安全地发送邮件</li><li>不需要公网 IP</li><li>无需配置复杂的网络规则</li><li>获得 Cloudflare 的 DDoS 保护</li></ul><h2 id="前提条件" tabindex="-1">前提条件 <a class="header-anchor" href="#前提条件" aria-label="Permalink to &quot;前提条件&quot;">​</a></h2><ol><li>一个 Cloudflare 账户</li><li>一个在 Cloudflare 上管理的域名</li><li>已安装的 Go Mail Server</li><li>安装了 <code>cloudflared</code> 客户端工具</li></ol><h2 id="安装-cloudflare-tunnel-客户端" tabindex="-1">安装 Cloudflare Tunnel 客户端 <a class="header-anchor" href="#安装-cloudflare-tunnel-客户端" aria-label="Permalink to &quot;安装 Cloudflare Tunnel 客户端&quot;">​</a></h2><h3 id="在-macos-上安装" tabindex="-1">在 macOS 上安装 <a class="header-anchor" href="#在-macos-上安装" aria-label="Permalink to &quot;在 macOS 上安装&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">brew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflare/cloudflare/cloudflared</span></span></code></pre></div><h3 id="在-linux-上安装" tabindex="-1">在 Linux 上安装 <a class="header-anchor" href="#在-linux-上安装" aria-label="Permalink to &quot;在 Linux 上安装&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Debian/Ubuntu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared.deb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dpkg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared.deb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># CentOS/RHEL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared.rpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-x86_64.rpm</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rpm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ivh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared.rpm</span></span></code></pre></div><h2 id="使用自动化脚本配置" tabindex="-1">使用自动化脚本配置 <a class="header-anchor" href="#使用自动化脚本配置" aria-label="Permalink to &quot;使用自动化脚本配置&quot;">​</a></h2><p>我们提供了一个自动化脚本来简化配置过程：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 下载脚本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://raw.githubusercontent.com/nuecms/mailer/main/setup_tunnel.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup_tunnel.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行脚本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./setup_tunnel.sh</span></span></code></pre></div><p>脚本将引导您完成整个设置过程，包括：</p><ul><li>登录到 Cloudflare 账户</li><li>创建 Tunnel</li><li>配置 DNS 记录</li><li>生成 DKIM 密钥</li><li>启动 Tunnel 服务</li></ul><h2 id="手动配置步骤" tabindex="-1">手动配置步骤 <a class="header-anchor" href="#手动配置步骤" aria-label="Permalink to &quot;手动配置步骤&quot;">​</a></h2><p>如果您希望手动配置，请按照以下步骤操作：</p><h3 id="_1-登录到-cloudflare" tabindex="-1">1. 登录到 Cloudflare <a class="header-anchor" href="#_1-登录到-cloudflare" aria-label="Permalink to &quot;1. 登录到 Cloudflare&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudflared</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span></span></code></pre></div><p>按照提示在浏览器中完成认证流程。</p><h3 id="_2-创建-tunnel" tabindex="-1">2. 创建 Tunnel <a class="header-anchor" href="#_2-创建-tunnel" aria-label="Permalink to &quot;2. 创建 Tunnel&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudflared</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mailer-tunnel</span></span></code></pre></div><p>这将创建一个新的 Tunnel 并保存凭证到本地。</p><h3 id="_3-创建配置文件" tabindex="-1">3. 创建配置文件 <a class="header-anchor" href="#_3-创建配置文件" aria-label="Permalink to &quot;3. 创建配置文件&quot;">​</a></h3><p>创建 <code>~/.cloudflared/config.yml</code> 文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">tunnel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;您的Tunnel ID&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">credentials-file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/root/.cloudflared/&lt;您的Tunnel ID&gt;.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mail.yourdomain.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">http://localhost:8025</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">smtp.yourdomain.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tcp://localhost:25</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">http_status:404</span></span></code></pre></div><h3 id="_4-配置-dns-记录" tabindex="-1">4. 配置 DNS 记录 <a class="header-anchor" href="#_4-配置-dns-记录" aria-label="Permalink to &quot;4. 配置 DNS 记录&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudflared</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mailer-tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mail.yourdomain.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudflared</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mailer-tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smtp.yourdomain.com</span></span></code></pre></div><h3 id="_5-修改-go-mail-server-配置" tabindex="-1">5. 修改 Go Mail Server 配置 <a class="header-anchor" href="#_5-修改-go-mail-server-配置" aria-label="Permalink to &quot;5. 修改 Go Mail Server 配置&quot;">​</a></h3><p>编辑 <code>config.json</code> 文件，允许外部连接：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;security&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;allowLocalOnly&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;requireAuth&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6-启动-tunnel" tabindex="-1">6. 启动 Tunnel <a class="header-anchor" href="#_6-启动-tunnel" aria-label="Permalink to &quot;6. 启动 Tunnel&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cloudflared</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tunnel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mailer-tunnel</span></span></code></pre></div><h2 id="使用-systemd-设置服务" tabindex="-1">使用 systemd 设置服务 <a class="header-anchor" href="#使用-systemd-设置服务" aria-label="Permalink to &quot;使用 systemd 设置服务&quot;">​</a></h2><p>为了确保 Tunnel 在后台运行并在系统重启后自动启动，可以创建一个 systemd 服务。</p><p>创建文件 <code>/etc/systemd/system/cloudflared-tunnel.service</code>：</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=Cloudflare Tunnel for Go Mail Server</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">After</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=simple</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/bin/cloudflared tunnel run mailer-tunnel</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Restart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=on-failure</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RestartSec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=5</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">StartLimitInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=60s</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">StartLimitBurst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=multi-user.target</span></span></code></pre></div><p>启用并启动服务：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared-tunnel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared-tunnel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cloudflared-tunnel</span></span></code></pre></div><h2 id="dns-记录配置" tabindex="-1">DNS 记录配置 <a class="header-anchor" href="#dns-记录配置" aria-label="Permalink to &quot;DNS 记录配置&quot;">​</a></h2><p>为了确保邮件服务正常工作，您需要配置几个重要的 DNS 记录：</p><h3 id="mx-记录" tabindex="-1">MX 记录 <a class="header-anchor" href="#mx-记录" aria-label="Permalink to &quot;MX 记录&quot;">​</a></h3>`,45)]))}const u=a(e,[["render",t]]);export{c as __pageData,u as default};
